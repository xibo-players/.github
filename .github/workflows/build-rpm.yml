name: Build RPM (reusable)

on:
  workflow_call:
    inputs:
      package-name:
        required: true
        type: string
        description: 'RPM package name (e.g. xiboplayer-electron)'
      build-command:
        type: string
        default: ''
        description: 'Build command before RPM (e.g. pnpm run build:linux). Empty = skip.'
      rpm-script:
        type: string
        default: 'build-rpm.sh'
        description: 'Path to the RPM build script'
      rpm-output-dir:
        type: string
        default: 'dist'
        description: 'Directory where RPM files are output'
      node-version:
        type: string
        default: '22'
      default-version:
        type: string
        default: '0.2.0'
      release-body:
        type: string
        default: ''
        description: 'Custom release body markdown. Empty = auto-generated.'
      publish-to-repo:
        type: boolean
        default: true
        description: 'Publish RPMs to gh-pages repository (default: true for all builds)'
      create-github-release:
        type: boolean
        default: true
        description: 'Create GitHub Release for tags (default: true, only runs on tags)'
      fedora-version:
        type: string
        default: '43'
        description: 'Fedora version number for repository structure'
      rpm-arch:
        type: string
        default: 'x86_64'
        description: 'Architecture for RPM packages (x86_64, aarch64, noarch)'

jobs:
  build:
    name: Build ${{ inputs.package-name }} RPM
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install rpm tools
        run: sudo apt-get update && sudo apt-get install -y rpm rpm-build createrepo-c systemd

      - uses: pnpm/action-setup@v4
        if: inputs.build-command != ''
        with:
          version: 8

      - uses: actions/setup-node@v4
        if: inputs.build-command != ''
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'pnpm'

      - name: Install dependencies
        if: inputs.build-command != ''
        run: pnpm install --no-frozen-lockfile

      - name: Build application
        if: inputs.build-command != ''
        run: ${{ inputs.build-command }}

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "version=${{ github.event.inputs.version || inputs.default-version }}" >> "$GITHUB_OUTPUT"
          elif [[ "${{ github.ref_type }}" == "tag" ]]; then
            TAG="${{ github.ref_name }}"
            echo "version=${TAG#v}" >> "$GITHUB_OUTPUT"
          else
            echo "version=${{ inputs.default-version }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Build RPM
        run: |
          if [ -f "${{ inputs.rpm-script }}" ]; then
            chmod +x ${{ inputs.rpm-script }}
            ./${{ inputs.rpm-script }} "${{ steps.version.outputs.version }}"
          else
            echo "Error: RPM script ${{ inputs.rpm-script }} not found"
            exit 1
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.package-name }}-rpm
          path: ${{ inputs.rpm-output-dir }}/*.rpm
          retention-days: 30

  release:
    name: Create GitHub Release
    needs: build
    if: inputs.create-github-release && startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.package-name }}-rpm
          path: dist/

      - uses: softprops/action-gh-release@v2
        with:
          name: "${{ inputs.package-name }} ${{ github.ref_name }}"
          body: ${{ inputs.release-body || format('## {0}\n\n### Installation\n```bash\nsudo dnf install ./{0}-*.rpm\n```', inputs.package-name) }}
          files: dist/*.rpm
          draft: false
          prerelease: false

  publish-rpm:
    name: Publish to gh-pages dnf repo
    needs: build
    if: inputs.publish-to-repo
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.package-name }}-rpm
          path: rpms/

      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
          fetch-depth: 1
        continue-on-error: true

      - name: Initialize gh-pages if needed
        run: |
          if [ ! -d "gh-pages/.git" ]; then
            mkdir -p gh-pages
            cd gh-pages
            git init
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git checkout -b gh-pages
          fi

      - name: Install createrepo
        run: sudo apt-get update && sudo apt-get install -y createrepo-c

      - name: Publish RPMs metadata to repo
        run: |
          # Create proper repository structure in gh-pages
          mkdir -p gh-pages/rpm/fedora/${{ inputs.fedora-version || '43' }}/x86_64
          mkdir -p gh-pages/rpm/fedora/${{ inputs.fedora-version || '43' }}/aarch64
          mkdir -p gh-pages/rpm/fedora/${{ inputs.fedora-version || '43' }}/noarch
          
          # Create temporary directories for metadata generation
          mkdir -p /tmp/rpm-repo-x86_64
          mkdir -p /tmp/rpm-repo-aarch64
          mkdir -p /tmp/rpm-repo-noarch
          
          # Distribute RPMs by architecture to temp directories for metadata generation
          for rpm in rpms/*.rpm; do
            if [ -f "$rpm" ]; then
              case "$rpm" in
                *.x86_64.rpm)
                  echo "Processing x86_64: $(basename $rpm)"
                  cp "$rpm" /tmp/rpm-repo-x86_64/
                  ;;
                *.aarch64.rpm)
                  echo "Processing aarch64: $(basename $rpm)"
                  cp "$rpm" /tmp/rpm-repo-aarch64/
                  ;;
                *.noarch.rpm)
                  echo "Processing noarch: $(basename $rpm)"
                  cp "$rpm" /tmp/rpm-repo-x86_64/
                  cp "$rpm" /tmp/rpm-repo-aarch64/
                  cp "$rpm" /tmp/rpm-repo-noarch/
                  ;;
              esac
            fi
          done
          
          # Create repository metadata for each architecture
          echo "Creating repository metadata..."
          if [ "$(ls -A /tmp/rpm-repo-x86_64/*.rpm 2>/dev/null)" ]; then
            createrepo_c /tmp/rpm-repo-x86_64/
            # Copy ONLY metadata, not RPM files
            cp -r /tmp/rpm-repo-x86_64/repodata gh-pages/rpm/fedora/${{ inputs.fedora-version || '43' }}/x86_64/
          fi
          
          if [ "$(ls -A /tmp/rpm-repo-aarch64/*.rpm 2>/dev/null)" ]; then
            createrepo_c /tmp/rpm-repo-aarch64/
            # Copy ONLY metadata, not RPM files
            cp -r /tmp/rpm-repo-aarch64/repodata gh-pages/rpm/fedora/${{ inputs.fedora-version || '43' }}/aarch64/
          fi
          
          if [ "$(ls -A /tmp/rpm-repo-noarch/*.rpm 2>/dev/null)" ]; then
            createrepo_c /tmp/rpm-repo-noarch/
            # Copy ONLY metadata, not RPM files
            cp -r /tmp/rpm-repo-noarch/repodata gh-pages/rpm/fedora/${{ inputs.fedora-version || '43' }}/noarch/
          fi
          
          echo "Repository metadata structure:"
          ls -laR gh-pages/rpm/

      - name: Create repository documentation
        run: |
          # Create README.md explaining the hybrid approach
          cat > gh-pages/rpm/README.md << 'EOF'
          # Xibo Players RPM Repository
          
          ## Repository Structure
          
          This repository uses a hybrid approach:
          - **Metadata** (repodata): Stored in gh-pages for DNF/YUM compatibility
          - **RPM files**: Stored as GitHub Release assets (supports large files up to 2GB)
          
          ## Installation
          
          ### For manual installation from releases:
          ```bash
          # Download RPM from releases (replace VERSION with actual release tag)
          wget https://github.com/${{ github.repository }}/releases/download/VERSION/${{ inputs.package-name }}.rpm
          sudo dnf install ./${{ inputs.package-name }}.rpm
          ```
          
          ### For DNF repository (coming soon):
          Repository metadata is available, but full DNF integration requires baseurl configuration to point to GitHub Releases.
          EOF
          
          # Create index.html for easy browsing
          cat > gh-pages/rpm/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>Xibo Players RPM Repository</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 40px; }
              h1 { color: #333; }
              .repo-config { background: #f5f5f5; padding: 15px; border-radius: 5px; margin: 20px 0; }
              pre { background: #272822; color: #f8f8f2; padding: 15px; border-radius: 5px; overflow-x: auto; }
              .arch { margin: 20px 0; }
              .warning { background: #fff3cd; border: 1px solid #ffc107; padding: 15px; border-radius: 5px; margin: 20px 0; }
            </style>
          </head>
          <body>
            <h1>Xibo Players RPM Repository</h1>
            
            <div class="warning">
              <h2>⚠️ Important: Hybrid Repository Structure</h2>
              <p>This repository stores <strong>metadata only</strong> in gh-pages. Large RPM files (>100MB) are stored as GitHub Release assets.</p>
              <p>For installation, please download RPMs directly from the <a href="https://github.com/${{ github.repository }}/releases">Releases page</a>.</p>
            </div>
            
            <div class="repo-config">
              <h2>Manual Installation</h2>
              <p>Download RPM files from GitHub Releases:</p>
              <pre># Download from releases (replace VERSION with actual release tag)
          wget https://github.com/${{ github.repository }}/releases/download/VERSION/${{ inputs.package-name }}.rpm
          
          # Install locally
          sudo dnf install ./${{ inputs.package-name }}.rpm</pre>
            </div>
            
            <div class="arch">
              <h2>Repository Metadata</h2>
              <p>Repository metadata is available for the following architectures:</p>
              <ul>
                <li><a href="fedora/${{ inputs.fedora-version || '43' }}/x86_64/">x86_64 (64-bit Intel/AMD)</a></li>
                <li><a href="fedora/${{ inputs.fedora-version || '43' }}/aarch64/">aarch64 (64-bit ARM)</a></li>
                <li><a href="fedora/${{ inputs.fedora-version || '43' }}/noarch/">noarch (Architecture independent)</a></li>
              </ul>
            </div>
            
            <hr>
            <p><small>Last updated: $(date -u)</small></p>
          </body>
          </html>
          EOF

      - name: Push to gh-pages
        run: |
          cd gh-pages
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          
          # Check if there are changes
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          git commit -m "Update RPM repository - ${{ inputs.package-name }}"
          
          # Pull with rebase to handle concurrent pushes
          git pull --rebase "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" gh-pages || true
          
          # Push changes
          git push "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" gh-pages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
