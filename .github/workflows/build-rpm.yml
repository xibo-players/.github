name: Build RPM (reusable)

on:
  workflow_call:
    inputs:
      package-name:
        required: true
        type: string
        description: 'RPM package name (e.g. xiboplayer-electron)'
      build-command:
        type: string
        default: ''
        description: 'Build command before RPM (e.g. pnpm run build:linux). Empty = skip.'
      rpm-script:
        type: string
        default: 'build-rpm.sh'
        description: 'Path to the RPM build script'
      rpm-output-dir:
        type: string
        default: 'dist'
        description: 'Directory where RPM files are output'
      node-version:
        type: string
        default: '22'
      default-version:
        type: string
        default: '0.2.0'
      release-body:
        type: string
        default: ''
        description: 'Custom release body markdown. Empty = auto-generated.'
      publish-to-repo:
        type: boolean
        default: true
        description: 'Publish RPMs to gh-pages repository (default: true for all builds)'
      create-github-release:
        type: boolean
        default: true
        description: 'Create GitHub Release for tags (default: true, only runs on tags)'

jobs:
  build:
    name: Build ${{ inputs.package-name }} RPM
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install rpm tools
        run: sudo apt-get update && sudo apt-get install -y rpm rpm-build createrepo-c systemd

      - uses: pnpm/action-setup@v4
        if: inputs.build-command != ''
        with:
          version: 8

      - uses: actions/setup-node@v4
        if: inputs.build-command != ''
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'pnpm'

      - name: Install dependencies
        if: inputs.build-command != ''
        run: pnpm install --no-frozen-lockfile

      - name: Build application
        if: inputs.build-command != ''
        run: ${{ inputs.build-command }}

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "version=${{ github.event.inputs.version || inputs.default-version }}" >> "$GITHUB_OUTPUT"
          elif [[ "${{ github.ref_type }}" == "tag" ]]; then
            TAG="${{ github.ref_name }}"
            echo "version=${TAG#v}" >> "$GITHUB_OUTPUT"
          else
            echo "version=${{ inputs.default-version }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Build RPM
        run: |
          if [ -f "${{ inputs.rpm-script }}" ]; then
            chmod +x ${{ inputs.rpm-script }}
            ./${{ inputs.rpm-script }} "${{ steps.version.outputs.version }}"
          else
            echo "Error: RPM script ${{ inputs.rpm-script }} not found"
            exit 1
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.package-name }}-rpm
          path: ${{ inputs.rpm-output-dir }}/*.rpm
          retention-days: 30

  release:
    name: Create GitHub Release
    needs: build
    if: inputs.create-github-release && startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.package-name }}-rpm
          path: dist/

      - uses: softprops/action-gh-release@v2
        with:
          name: "${{ inputs.package-name }} ${{ github.ref_name }}"
          body: ${{ inputs.release-body || format('## {0}\n\n### Installation\n```bash\nsudo dnf install ./{0}-*.rpm\n```', inputs.package-name) }}
          files: dist/*.rpm
          draft: false
          prerelease: false

  publish-rpm:
    name: Publish to gh-pages dnf repo
    needs: build
    if: inputs.publish-to-repo
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.package-name }}-rpm
          path: rpms/

      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
          fetch-depth: 1
        continue-on-error: true

      - name: Initialize gh-pages if needed
        run: |
          if [ ! -d "gh-pages/.git" ]; then
            mkdir -p gh-pages
            cd gh-pages
            git init
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git checkout -b gh-pages
          fi

      - name: Install createrepo
        run: sudo apt-get update && sudo apt-get install -y createrepo-c

      - name: Publish RPMs to repo
        run: |
          # Create repository metadata without storing actual RPM files
          # RPMs are only in GitHub Releases
          mkdir -p /tmp/rpm-repo/x86_64
          mkdir -p /tmp/rpm-repo/aarch64
          mkdir -p /tmp/rpm-repo/noarch
          
          # Categorize RPMs by architecture in temp directory
          for rpm in rpms/*.rpm; do
            if [ -f "$rpm" ]; then
              case "$rpm" in
                *.x86_64.rpm)
                  echo "Processing x86_64: $(basename $rpm)"
                  cp "$rpm" /tmp/rpm-repo/x86_64/
                  ;;
                *.aarch64.rpm)
                  echo "Processing aarch64: $(basename $rpm)"
                  cp "$rpm" /tmp/rpm-repo/aarch64/
                  ;;
                *.noarch.rpm)
                  echo "Processing noarch: $(basename $rpm)"
                  cp "$rpm" /tmp/rpm-repo/x86_64/
                  cp "$rpm" /tmp/rpm-repo/aarch64/
                  cp "$rpm" /tmp/rpm-repo/noarch/
                  ;;
              esac
            fi
          done
          
          # Generate metadata for each architecture
          echo "Generating repository metadata..."
          for arch in x86_64 aarch64 noarch; do
            if ls /tmp/rpm-repo/$arch/*.rpm 1> /dev/null 2>&1; then
              createrepo_c /tmp/rpm-repo/$arch/
              # Copy ONLY metadata (repodata directory) to gh-pages
              mkdir -p gh-pages/rpm/fedora/43/$arch
              cp -r /tmp/rpm-repo/$arch/repodata gh-pages/rpm/fedora/43/$arch/
              echo "âœ“ Metadata created for $arch"
            fi
          done
          
          # Create index.html for easy browsing
          cat > gh-pages/rpm/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>Xibo Players - Download RPMs</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 40px; }
              h1 { color: #333; }
              .download-section { background: #f5f5f5; padding: 15px; border-radius: 5px; margin: 20px 0; }
              pre { background: #272822; color: #f8f8f2; padding: 15px; border-radius: 5px; overflow-x: auto; }
              .note { background: #fffacd; padding: 10px; border-left: 4px solid #ffd700; margin: 20px 0; }
            </style>
          </head>
          <body>
            <h1>Xibo Players - RPM Downloads</h1>
            
            <div class="note">
              <strong>ðŸ“¦ RPM Storage:</strong> All RPM packages are stored in <strong>GitHub Releases</strong>.<br>
              This page contains only repository metadata for package management tools.
            </div>
            
            <div class="download-section">
              <h2>ðŸ”½ Download RPMs</h2>
              <p>Download RPM packages directly from GitHub Releases:</p>
              <pre>https://github.com/${{ github.repository }}/releases</pre>
              
              <h3>Manual Installation</h3>
              <pre># Download from releases page, then:
          sudo dnf install ./package-name-*.rpm</pre>
            </div>
            
            <div class="download-section">
              <h2>ðŸ“‹ Repository Metadata</h2>
              <p>This site contains repository metadata (repodata) for package management integration.</p>
              <p>Repository metadata structure:</p>
              <ul>
                <li><a href="fedora/43/x86_64/repodata/">x86_64 metadata</a></li>
                <li><a href="fedora/43/aarch64/repodata/">aarch64 metadata</a></li>
                <li><a href="fedora/43/noarch/repodata/">noarch metadata</a></li>
              </ul>
            </div>
            
            <hr>
            <p><small>Last updated: $(date -u) | RPMs hosted in <a href="https://github.com/${{ github.repository }}/releases">GitHub Releases</a></small></p>
          </body>
          </html>
          EOF
          
          echo "Repository structure:"
          ls -laR gh-pages/rpm/

      - name: Push to gh-pages
        run: |
          cd gh-pages
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          
          # Check if there are changes
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          git commit -m "Update RPM repository - ${{ inputs.package-name }}"
          
          # Pull with rebase to handle concurrent pushes
          git pull --rebase "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" gh-pages || true
          
          # Push changes
          git push "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" gh-pages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
