name: Build ISO (reusable)

on:
  workflow_call:
    inputs:
      package-name:
        required: true
        type: string
        description: 'Package name for the kiosk image (e.g. xiboplayer-electron)'
      kickstart-file:
        type: string
        default: 'kickstart/xibo-kiosk.ks'
        description: 'Path to Kickstart file for installer ISO'
      mkosi-config:
        type: string
        default: 'mkosi.conf'
        description: 'Path to mkosi configuration file'
      build-installer:
        type: boolean
        default: true
        description: 'Build installer ISO using kickstart'
      build-disk-images:
        type: boolean
        default: true
        description: 'Build disk images (QCOW2 and raw) using mkosi'
      architectures:
        type: string
        default: 'x86_64'
        description: 'Comma-separated list of architectures (x86_64, aarch64)'
      default-version:
        type: string
        default: '0.2.0'
      release-body:
        type: string
        default: ''
        description: 'Custom release body markdown. Empty = auto-generated.'

jobs:
  build-disk-images-x86_64:
    if: inputs.build-disk-images == true && contains(inputs.architectures, 'x86_64')
    name: Build Disk Images (x86_64)
    runs-on: ubuntu-latest
    container:
      image: fedora:43
      options: --privileged

    steps:
      - name: Install dependencies
        run: |
          dnf install -y \
            git \
            mkosi \
            systemd-container \
            qemu-img \
            mtools \
            xz

      - uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "version=${{ github.event.inputs.version || inputs.default-version }}" >> "$GITHUB_OUTPUT"
          elif [[ "${{ github.ref_type }}" == "tag" ]]; then
            TAG="${{ github.ref_name }}"
            echo "version=${TAG#v}" >> "$GITHUB_OUTPUT"
          else
            echo "version=${{ inputs.default-version }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Prepare mkosi configuration
        run: |
          if [ -f "${{ inputs.mkosi-config }}" ]; then
            echo "Using provided mkosi configuration"
            if [ "${{ inputs.mkosi-config }}" != "mkosi.conf" ]; then
              cp "${{ inputs.mkosi-config }}" mkosi.conf
            fi
          else
            echo "Using template mkosi configuration"
            cp scripts/mkosi/mkosi.conf.template mkosi.conf
            # Customize ImageId
            sed -i "s/ImageId=.*/ImageId=${{ inputs.package-name }}-kiosk/" mkosi.conf
          fi

      - name: Set file permissions
        run: |
          # Set permissions for any scripts in mkosi-extra
          find mkosi-extra -type f -name "*.sh" -exec chmod 755 {} \; 2>/dev/null || true
          find mkosi-extra -type f -name "doas.conf" -exec chmod 600 {} \; 2>/dev/null || true

      - name: Build disk image with mkosi
        run: |
          # Retry once on transient mirror/checksum failures
          mkosi --force --image-version=${{ steps.version.outputs.version }} || \
            (echo "Retrying after transient failure..." && sleep 10 && \
             mkosi --force --image-version=${{ steps.version.outputs.version }})

      - name: Convert and compress images
        env:
          VERSION: ${{ steps.version.outputs.version }}
          PACKAGE: ${{ inputs.package-name }}
        run: |
          cd output
          # Rename raw image
          mv *.raw ${PACKAGE}-kiosk_${VERSION}_x86_64.raw 2>/dev/null || true
          
          # Create QCOW2 for VMs
          if [ -f ${PACKAGE}-kiosk_${VERSION}_x86_64.raw ]; then
            qemu-img convert -f raw -O qcow2 -c ${PACKAGE}-kiosk_${VERSION}_x86_64.raw ${PACKAGE}-kiosk_${VERSION}_x86_64.qcow2
            qemu-img resize ${PACKAGE}-kiosk_${VERSION}_x86_64.qcow2 16G
            
            # Compress raw image
            xz -T0 -9 ${PACKAGE}-kiosk_${VERSION}_x86_64.raw
          fi

      - name: List output
        run: ls -lah output/

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.package-name }}-images-x86_64
          path: |
            output/*.qcow2
            output/*.raw.xz
          retention-days: 30

  build-disk-images-aarch64:
    if: inputs.build-disk-images == true && contains(inputs.architectures, 'aarch64')
    name: Build Disk Images (aarch64)
    runs-on: ubuntu-24.04-arm
    container:
      image: fedora:43
      options: --privileged

    steps:
      - name: Install dependencies
        run: |
          dnf install -y \
            git \
            mkosi \
            systemd-container \
            mtools \
            xz

      - uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "version=${{ github.event.inputs.version || inputs.default-version }}" >> "$GITHUB_OUTPUT"
          elif [[ "${{ github.ref_type }}" == "tag" ]]; then
            TAG="${{ github.ref_name }}"
            echo "version=${TAG#v}" >> "$GITHUB_OUTPUT"
          else
            echo "version=${{ inputs.default-version }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Prepare mkosi configuration
        run: |
          if [ -f "${{ inputs.mkosi-config }}" ]; then
            echo "Using provided mkosi configuration"
            if [ "${{ inputs.mkosi-config }}" != "mkosi.conf" ]; then
              cp "${{ inputs.mkosi-config }}" mkosi.conf
            fi
          else
            echo "Using template mkosi configuration"
            cp scripts/mkosi/mkosi.conf.template mkosi.conf
            sed -i "s/ImageId=.*/ImageId=${{ inputs.package-name }}-kiosk/" mkosi.conf
          fi

      - name: Set file permissions
        run: |
          find mkosi-extra -type f -name "*.sh" -exec chmod 755 {} \; 2>/dev/null || true
          find mkosi-extra -type f -name "doas.conf" -exec chmod 600 {} \; 2>/dev/null || true

      - name: Build disk image
        run: |
          mkosi --force --image-version=${{ steps.version.outputs.version }} || \
            (echo "Retrying after transient failure..." && sleep 10 && \
             mkosi --force --image-version=${{ steps.version.outputs.version }})

      - name: Rename and compress
        env:
          VERSION: ${{ steps.version.outputs.version }}
          PACKAGE: ${{ inputs.package-name }}
        run: |
          cd output
          mv *.raw ${PACKAGE}-kiosk_${VERSION}_aarch64.raw 2>/dev/null || true
          if [ -f ${PACKAGE}-kiosk_${VERSION}_aarch64.raw ]; then
            xz -T0 -9 ${PACKAGE}-kiosk_${VERSION}_aarch64.raw
          fi

      - name: List output
        run: ls -lah output/

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.package-name }}-images-aarch64
          path: output/*.raw.xz
          retention-days: 30

  build-installer-iso:
    if: inputs.build-installer == true
    name: Build Installer ISO
    runs-on: ubuntu-latest
    container:
      image: fedora:43
      options: --privileged

    steps:
      - name: Install dependencies
        run: dnf install -y lorax pykickstart curl

      - uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "version=${{ github.event.inputs.version || inputs.default-version }}" >> "$GITHUB_OUTPUT"
          elif [[ "${{ github.ref_type }}" == "tag" ]]; then
            TAG="${{ github.ref_name }}"
            echo "version=${TAG#v}" >> "$GITHUB_OUTPUT"
          else
            echo "version=${{ inputs.default-version }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Download Fedora netinstall ISO
        run: |
          curl -L -o /tmp/fedora-netinst.iso \
            "https://ftp.plusline.net/fedora/linux/releases/43/Everything/x86_64/iso/Fedora-Everything-netinst-x86_64-43-1.6.iso"

      - name: Validate Kickstart file
        run: |
          if [ -f "${{ inputs.kickstart-file }}" ]; then
            echo "Using provided kickstart file: ${{ inputs.kickstart-file }}"
            ksvalidator "${{ inputs.kickstart-file }}" || echo "Warning: Kickstart validation failed"
          else
            echo "Error: Kickstart file not found: ${{ inputs.kickstart-file }}"
            exit 1
          fi

      - name: Build installer ISO
        env:
          VERSION: ${{ steps.version.outputs.version }}
          PACKAGE: ${{ inputs.package-name }}
        run: |
          mkksiso --skip-mkefiboot --ks "${{ inputs.kickstart-file }}" \
            /tmp/fedora-netinst.iso \
            ${PACKAGE}-kiosk-installer_${VERSION}_x86_64.iso

      - name: List ISO
        run: ls -lah *.iso

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.package-name }}-installer-iso
          path: "*.iso"
          retention-days: 30

  release:
    name: Create GitHub Release
    needs: [build-disk-images-x86_64, build-disk-images-aarch64, build-installer-iso]
    if: always() && (needs.build-disk-images-x86_64.result == 'success' || needs.build-disk-images-aarch64.result == 'success' || needs.build-installer-iso.result == 'success')
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            echo "tag=${{ github.ref_name }}" >> "$GITHUB_OUTPUT"
          else
            echo "tag=v${{ inputs.default-version }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Flatten artifacts
        run: |
          mkdir -p release
          find artifacts -type f \( -name "*.iso" -o -name "*.qcow2" -o -name "*.raw.xz" \) -exec mv {} release/ \;
          ls -lah release/

      - name: Generate checksums
        run: |
          cd release
          sha256sum * > SHA256SUMS
          cat SHA256SUMS

      - name: Create or update GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.version.outputs.tag }}
          PACKAGE: ${{ inputs.package-name }}
        run: |
          # Create release if it doesn't exist
          gh release view "$TAG" --json tagName >/dev/null 2>&1 || \
            gh release create "$TAG" \
              --title "${PACKAGE} ${TAG}" \
              --notes "## ${PACKAGE} ${TAG}

          ### Available Images

          | Image | Use Case |
          |-------|----------|
          | **Installer ISO** (x86_64) | Flash to USB, boot and install on any x86_64 PC. Automated Fedora install with kiosk config. |
          | **QCOW2** (x86_64) | Virtual machines â€” GNOME Boxes, virt-manager, Proxmox, QEMU. Ready to boot, no install needed. |
          | **Raw.xz** (x86_64) | Write directly to SSD/SD card with dd or Balena Etcher. For PCs, Intel NUCs, kiosk hardware. |
          | **Raw.xz** (aarch64) | Write to SD card for Raspberry Pi 4/5, or eMMC for ARM SBCs. |

          ### Installation

          **USB installer (recommended for PCs):**
          \`\`\`bash
          sudo dd if=${PACKAGE}-kiosk-installer_*_x86_64.iso of=/dev/sdX bs=8M status=progress
          \`\`\`

          **Direct write (PCs, Raspberry Pi, ARM boards):**
          \`\`\`bash
          xz -dc ${PACKAGE}-kiosk_*_x86_64.raw.xz | sudo dd of=/dev/sdX bs=8M status=progress
          \`\`\`

          **Virtual machine:**
          \`\`\`bash
          qemu-system-x86_64 -enable-kvm -m 2G -drive file=${PACKAGE}-kiosk_*_x86_64.qcow2
          \`\`\`

          ### Default Credentials
          - User: \`xibo\` / Password: \`xibo\`
          - Root: \`root\` (locked by default)

          > **Change passwords after first login!**

          ### Verification
          \`\`\`bash
          sha256sum -c SHA256SUMS
          \`\`\`"

          # Upload all artifacts (--clobber overwrites existing)
          gh release upload "$TAG" release/* --clobber

  publish-iso:
    name: Trigger repository update
    needs: [release]
    if: needs.release.result == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: Trigger ghpages repo update
        env:
          GH_TOKEN: ${{ secrets.GHPAGES_TOKEN }}
        run: |
          if [ -n "$GH_TOKEN" ]; then
            gh api repos/xibo-players/xibo-players.github.io/dispatches \
              -f event_type=update-repos \
              -f "client_payload[source]=${{ inputs.package-name }}" || true
          fi
